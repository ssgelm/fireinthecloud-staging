
<!doctype html>
<!-- START OF _layouts/default.html -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" >
		<meta content="width=device-width,initial-scale=1" name="viewport">
		<meta content="A place to talk about the various DevOps-related tips and tricks I have picked up over the years." name="description">
		<meta content="Fire in the Cloud" name="author">

		<title>Resizing a Xen DomU's Loopback Volume Online &mdash; Fire in the Cloud</title>

		<!-- Styles -->
		<link href="/stylesheets/main.css" rel="stylesheet">

		<!-- Google webfonts -->
		<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Tangerine">
		<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Cousine">

		<link href="http://feeds.feedburner.com/turkeltaub" rel="alternate" title="Fire in the Cloud" type="application/rss+xml" />

	</head>
	<body>

		<div class="wrap">

			<header>
                <a href="/"><div class="title">Fire in the Cloud</div></a>

				<div class="navi">
					<ul>
						<li><a href="/">Blog</a></li>
						<li><a href="/blog/archives">Archives</a></li>
						<li><a href="/atom.xml">RSS</a></li>
					</ul>
				</div> <!-- // .navi -->
			</header>

				<!-- START OF _layouts/post.html -->

<!-- START OF _includes/article.html -->


<article>
    <header>
        <h1><a href="/blog/2014/06/21/resizing-a-xen-domus-loopback-volume-online/">Resizing a Xen DomU's Loopback Volume Online</a></h1>
        <time>June 21 2014</time>
    </header>
    

    <div class="content">
        <p>At Braintree we use Xen running on Debian for virtualization.  We have two generations of Dom0s.  Our newer generation uses LVM for VM storage and our older generation uses disk images attached to the VMs via loopback devices.  We often have the need to enlarge a disk volume attached to a DomU.  In order to maintain the highest uptime possible we prefer to resize the VM online without needing to shutdown or even reboot the VM.  All of our services are highly available so they can tolerate a reboot of a single VM but we still try not to rely on that if possible.  Resizing an LVM-backed volume online is a pretty simple process as long as you are presenting the volume to the DomU as a partition instead of an entire disk (just <code>lvresize</code> it on the Dom0 then <code>resize2fs</code> it on the DomU).  Pretty much <a href="http://theninthdimension.blogspot.com/2010/01/how-to-resize-grow-xen-vm-partition.html">all</a> <a href="http://grantmcwilliams.com/item/262-resize-disk-image-used-as-xen-domu-hard-drive">articles</a> <a href="http://amandine.aupetit.info/187/add-disk-space-to-a-img-disk-image-for-use-with-xen-for-example/">about</a> resizing a Xen loopback volume list the first step as shutting down the DomU.  <a href="http://serverfault.com/questions/65340/how-do-i-get-a-xen-domu-to-notice-a-change-in-the-block-size-of-one-of-its-phy-d">Some</a> go as far as to claim it&rsquo;s impossible to resize it online.</p>

<!-- more -->


<p>Undeterred, I experimented with some methods to resize the disk online and figured it out!  There are a few caveats to this method:</p>

<ul>
<li>This will only work with raw disk images.  It may be possible to resize QCOW2 and VHD disk images using a similar process (with the appropriate tool instead of <code>dd</code>) but I have not tested it.</li>
<li>This assumes that the disk image is exposed to the vm as a partition (e.g. /dev/xvda1) and that the image itself is not partitioned.  Getting linux to re-read the partition table of a disk that has mounted partitions without a reboot is unreliable at best but is sometimes possible.</li>
<li>This should go without saying but <em>always</em> back up your data before doing this.  I have sucessfully used it a number of times however resizing a disk is always inherently risky and doing so online is even more so.  Better safe than sorry.</li>
<li>I have confirmed that this works on Xen 4.0 running on Debian Squeeze.  Newer versions of Xen should work fine but older versions may not (<code>xm block-configure</code> was broken in Xen for a long time which prevents this process from working).</li>
</ul>


<h2>Resizing the disk</h2>

<p>In short, the process involves expanding the disk image, resizing the loopback device, telling xend to reconfigure the block device, then resizing the filesystem on the DomU.</p>

<ul>
<li><p>On the Dom0</p>

<ol>
<li><p> Use <code>dd</code> to expand the disk image, replacing <code>IMAGEFILENAME</code> with the path to the image you are resizing and <code>nn</code> with the number of GB you want to add to the volume (i.e. 50K for 50 GB):</p>

<p>  <code>sudo dd if=/dev/zero of=IMAGEFILENAME bs=1M count=nnK oflag=append conv=notrunc</code></p></li>
<li><p> Next we need to resize the loopback device.</p>

<ol>
<li><p> Get the name of the loopback device Xen is using, again replacing <code>IMAGEFILENAME</code> with the path to the image you want to resize:</p>

<p>  <code>sudo losetup -j IMAGEFILENAME</code></p></li>
<li><p> Resize the loopback device you just found.  Replace <code>LOOPDEV</code> with the loopback device the previous command returned (should be something like <code>/dev/loop1</code>):</p>

<p>  <code>sudo losetup -c LOOPDEV</code></p></li>
</ol>
</li>
<li><p> Now we need to tell Xen to reread the loopback device size.  Replace DOMUNAME with the name of the Xen DomU, IMAGEFILENAME with the full path to the disk image you have resized, and XENBLOCKDEV with the block device on the DomU (something like <code>xvda1</code>).  (Note that in every case I have tried it this command has returned an error saying <code>Error:</code> <code>Refusing to reconfigure device</code> even when it works successfully.  Go figure.):</p>

<p>  <code>sudo xm block-configure DOMUNAME file:IMAGEFILENAME XENBLOCKDEV w</code></p></li>
</ol>
</li>
<li><p>On the DomU</p>

<ol>
<li><p> First, make sure <code>parted</code> is installed.  In the case of Debian-based distros you can just run:</p>

<p>  <code>sudo apt-get install parted</code></p></li>
<li><p> Now the OS needs to be told to reread the partition table:</p>

<p>  <code>sudo partparobe</code></p></li>
<li><p> At this point you should be able to see that the partition is larger if you run <code>sudo fdisk -l /dev/XENBLOCKDEV</code> (replacing the appropriate block device).  You can now resize it (replacing <code>XENBLOCKDEV</code> with the appropriate device):</p>

<p>  <code>sudo resize2fs /dev/XENBLOCKDEV</code></p></li>
</ol>
</li>
</ul>


<p>If you do a <code>df</code> now you should see that the partition has, in fact, been resized.</p>

    </div>
    


    <footer>
        


		



  
		
			Tagged under
		
    <a class='category' href='/blog/categories/xen/'>xen</a>
	


    </footer>

</article>
<!-- END OF _includes/article.html -->



<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'fireinthecloud';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<!-- END OF _/layouts/post.html -->


			<footer>
				Copyright &copy; 2014

	Stephen Gelman


			</footer>

		</div> <!-- // .wrap -->

        <!-- jQuery and plugins -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

        <!-- Modernizr -->
        <script type="text/javascript" src="/js/modernizr-2.0.js"></script>

        <!-- Syntax highlighter -->
        <!-- <link href="/stylesheets/prettify-hemisu.css" type="text/css" rel="stylesheet" /> -->
        <script type="text/javascript" src="/js/main.js"></script>

        
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-52141637-1']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        

        

    </body>
</html>
<!-- END OF _layouts/default.html -->
